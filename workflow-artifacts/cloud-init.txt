#!/bin/bash

# Update system packages
apt-get update

# Install necessary packages
apt-get install -y build-essential pkg-config libssl-dev protobuf-compiler git curl

# Install Rust using rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# Ensure the cargo/bin directory is in PATH
source $HOME/.cargo/env

# Clone the candle repository
git clone https://github.com/huggingface/candle.git /opt/candle

# Define a working directory
WORK_DIR="/opt/actions-runner"

# Change ownership to the runner user
chown -R runner $WORK_DIR

# Configure the runner
su - runner -c "$WORK_DIR/config.sh --unattended --url https://github.com/nogibjj/candle_scott_Azure_vm --token $RUNNER_TOKEN"

# Schedule the runner to start immediately but in the background
nohup su - runner -c "$WORK_DIR/run.sh" &
